"use strict";var M=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var H=Object.prototype.hasOwnProperty;var J=(i,t)=>{for(var n in t)M(i,n,{get:t[n],enumerable:!0})},ee=(i,t,n,u)=>{if(t&&typeof t=="object"||typeof t=="function")for(let d of j(t))!H.call(i,d)&&d!==n&&M(i,d,{get:()=>t[d],enumerable:!(u=X(t,d))||u.enumerable});return i};var te=i=>ee(M({},"__esModule",{value:!0}),i);var ae={};J(ae,{default:()=>v});module.exports=te(ae);var s=require("@raycast/api"),C=require("child_process");var ie=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],se=["B","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],re=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],oe=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],$=(i,t,n)=>{let u=i;return typeof t=="string"||Array.isArray(t)?u=i.toLocaleString(t,n):(t===!0||n!==void 0)&&(u=i.toLocaleString(void 0,n)),u};function x(i,t){if(!Number.isFinite(i))throw new TypeError(`Expected a finite number, got ${typeof i}: ${i}`);t={bits:!1,binary:!1,space:!0,...t};let n=t.bits?t.binary?oe:re:t.binary?se:ie,u=t.space?" ":"";if(t.signed&&i===0)return` 0${u}${n[0]}`;let d=i<0,y=d?"-":t.signed?"+":"";d&&(i=-i);let l;if(t.minimumFractionDigits!==void 0&&(l={minimumFractionDigits:t.minimumFractionDigits}),t.maximumFractionDigits!==void 0&&(l={maximumFractionDigits:t.maximumFractionDigits,...l}),i<1){let T=$(i,t.locale,l);return y+T+u+n[0]}let b=Math.min(Math.floor(t.binary?Math.log(i)/Math.log(1024):Math.log10(i)/3),n.length-1);i/=(t.binary?1024:1e3)**b,l||(i=i.toPrecision(3));let w=$(Number(i),t.locale,l),A=n[b];return y+w+u+A}var m=require("react");var S=require("react"),ne=()=>{};function ce(i,t){let n=(0,S.useRef)(ne);(0,S.useEffect)(()=>{n.current=i},[i]),(0,S.useEffect)(()=>{if(n.current(),(t??0)>0){let d=Math.max(t??0,1e3),y=setInterval(()=>n.current(),d);return()=>clearInterval(y)}},[t])}var F=ce;var p=require("react/jsx-runtime");function v(){let[i,t]=(0,m.useState)([]),[n,u]=(0,m.useState)([]),[d,y]=(0,m.useState)(""),l=(0,s.getPreferenceValues)(),b=l.shouldSearchInPaths,w=l.shouldSearchInPid,A=l.shouldPrioritizeAppsWhenFiltering,T=l.shouldShowPID,k=l.shouldShowPath,R=+l.refreshDuration,K=l.closeWindowAfterKill,D=l.clearSearchBarAfterKill,U=l.goToRootAfterKill,[E,W]=(0,m.useState)(l.sortByMem?"memory":"cpu"),[P,Y]=(0,m.useState)(l.aggregateApps),L=()=>{(0,C.exec)("ps -eo pid,ppid,pcpu,rss,comm",(e,c)=>{if(e!=null)return;let a=c.split(`
`).map(g=>{let N=["","","","","",""],B=/(\d+)\s+(\d+)\s+(\d+[.|,]\d+)\s+(\d+)\s+(.*)/,[,r,f,o,h,I]=g.match(B)??N,q=I.match(/[^/]*[^/]*$/i)?.[0]??"",O=I.includes(".prefPane"),Q=I.includes(".app/");return{id:parseInt(r),pid:parseInt(f),cpu:parseFloat(o),mem:parseInt(h),type:O?"prefPane":Q?"app":"binary",path:I,processName:q}}).filter(g=>g.processName!=="");t(a)})};F(L,R),(0,m.useEffect)(()=>{let e=i;P&&(e=V(e)),e.sort((c,a)=>E==="memory"?c.mem>a.mem?-1:1:c.cpu>a.cpu?-1:1),u(e)},[i,E,P]);let G=e=>e.type==="prefPane"?{fileIcon:e.path?.replace(/(.+\.prefPane)(.+)/,"$1")??""}:e.type==="app"||e.type==="aggregatedApp"?{fileIcon:e.path?.replace(/(.+\.app)(.+)/,"$1")??""}:"/System/Library/CoreServices/CoreTypes.bundle/Contents/Resources/ExecutableBinaryIcon.icns",Z=e=>{(0,C.exec)(`kill -9 ${e.id}`),t(n.filter(c=>c.id!==e.id)),K&&(0,s.closeMainWindow)(),U&&(0,s.popToRoot)({clearSearchBar:D}),D&&(0,s.clearSearchBar)({forceScrollToTop:!0}),(0,s.showToast)({title:`Killed ${e.processName==="-"?`process ${e.id}`:e.processName}`,style:s.Toast.Style.Success})},_=e=>{let c=[];return e.type==="aggregatedApp"&&e.appName!=null&&c.push(e.appName),T&&c.push(e.id.toString()),k&&c.push(e.path),c.join(" - ")},V=e=>{let c=Array(),a=new Map;a.set(1,{process:{id:1},childNodes:[]});let g=Array();e.forEach(r=>{if(r.type==="app"){g.push(r.id);let f=a.get(r.id);f==null?(f={process:r,childNodes:[]},a.set(r.id,f)):f.process=r;let o=a.get(r.pid);if(o==null)o={process:void 0,childNodes:[f]},a.set(r.pid,o);else if(o.process==null)o.childNodes.push(f);else{let h;for(;o?.process!=null&&o.process.pid!==1&&(h=a.get(o.process.pid))!=null;)o=h;o?.childNodes.push(f)}o.process?.id!==1&&(o.childNodes=o.childNodes.concat(f.childNodes),f.childNodes=[])}else c.push(r)});let N=a.get(1)?.childNodes,B=Array();return N?.forEach(r=>{if(r.process==null)return;B.push(r.process.id);let f=r.childNodes.map(o=>o.process?.id).filter(o=>o!=null);B=B.concat(f),c.push({id:r.process.id,pid:r.process.pid,cpu:(r.childNodes?.reduce((o,h)=>o+(h.process?.cpu??0),0)??0)+r.process.cpu,mem:(r.childNodes?.reduce((o,h)=>o+(h.process?.mem??0),0)??0)+r.process.mem,type:"aggregatedApp",path:r.process.path,processName:r.process.processName,appName:r.process.path.match(/(?<=\/)[^/]+(?=\.app\/)/)?.[0]})}),c},z=n.length;return(0,p.jsx)(s.List,{isLoading:n.length===0,searchBarPlaceholder:"Filter by name",onSearchTextChange:e=>y(e),searchBarAccessory:(0,p.jsx)(s.List.Dropdown,{tooltip:"Filter",storeValue:!0,onChange:e=>W(e),children:(0,p.jsxs)(s.List.Dropdown.Section,{title:"Sort By",children:[(0,p.jsx)(s.List.Dropdown.Item,{title:"CPU Usage",value:"cpu"}),(0,p.jsx)(s.List.Dropdown.Item,{title:"Memory Usage",value:"memory"})]})}),children:(0,p.jsx)(s.List.Section,{title:"Processes",subtitle:`${z} running`,children:n.filter(e=>{if(d==="")return!0;let c=e.processName.toLowerCase().includes(d.toLowerCase()),a=b&&e.path.toLowerCase().match(new RegExp(`.+${d}.*\\.[app|framework|prefpane]`,"ig"))!=null,g=w&&e.id.toString().includes(d),N=e.type==="aggregatedApp"&&e.appName?.toLowerCase().includes(d.toLowerCase());return c||a||g||N}).sort((e,c)=>{if(A){let a=["app","aggregatedApp"];if(a.includes(e.type)&&!a.includes(c.type))return-1;if(!a.includes(e.type)&&a.includes(c.type))return 1}return 0}).map((e,c)=>{let a=G(e);return(0,p.jsx)(s.List.Item,{title:e.processName,subtitle:_(e),icon:a,accessories:[{text:`${e.cpu.toFixed(2)}%`,icon:"cpu.svg",tooltip:"% CPU"},{text:x(e.mem*1024),icon:"memorychip.svg",tooltip:"Memory"}],actions:(0,p.jsxs)(s.ActionPanel,{children:[(0,p.jsx)(s.Action,{title:"Kill",icon:s.Icon.XMarkCircle,onAction:()=>Z(e)}),e.path==null?null:(0,p.jsx)(s.Action.CopyToClipboard,{title:"Copy Path",content:e.path}),(0,p.jsx)(s.Action,{title:"Reload",icon:s.Icon.ArrowClockwise,shortcut:{key:"r",modifiers:["cmd"]},onAction:()=>L()}),(0,p.jsx)(s.Action,{title:`${P?"Dis":"En"}able Aggregating Apps`,icon:s.Icon.AppWindow,shortcut:{key:"tab",modifiers:["shift"]},onAction:()=>{Y(!P),(0,s.showToast)({title:`${P?"Dis":"En"}abled aggregating apps`})}})]})},c)})})})}
